<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automatic First-Aid Machine</title>
</head>

<body>

<header>ЁЯПе Automatic First-Aid Machine</header>

<div class="card">
  <video id="cam" autoplay muted playsinline></video>
  <div id="out">ЁЯдЦ рдорд╢реАрди рддрдпрд╛рд░ рдЖрд╣реЗ...</div>
  <div id="countdown"></div>

  <button onclick="manualStart()">ЁЯЪи Emergency / рд╕рдорд╕реНрдпрд╛ рдмреЛрд▓рд╛</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/* ========== GLOBAL ========== */
let step = 0;
let disease="", medicine="", doseInfo="";
let recognition;
let resetting = false;

/* ========== ESP32 ========== */
const ESP32_IP = "http://192.168.43.101";
function sendToESP32(cmd){
  fetch(ESP32_IP + "/" + cmd).catch(()=>{});
}

/* ========== SPEAK ========== */
function speak(text, reset=false){
  out.innerHTML += "<br>ЁЯдЦ <b>" + text + "</b>";
  let msg = new SpeechSynthesisUtterance(text);
  msg.lang = "mr-IN";
  msg.rate = 0.65;
  if(reset) msg.onend = ()=> startCountdown(15);
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

/* ========== COUNTDOWN ========== */
function startCountdown(sec){
  resetting = true;
  let c = sec;
  let t = setInterval(()=>{
    countdown.innerText = "тП│ Reset рд╣реЛрдд рдЖрд╣реЗ : " + c;
    c--;
    if(c < 0){
      clearInterval(t);
      location.reload();
    }
  },1000);
}

/* ========== BEEP + MIC ========== */
function beepAndListen(){
  document.getElementById("beep").play();
  startListening();
}

/* ========== CONTINUOUS MIC ========== */
function startListening(){
  if(resetting) return;

  recognition = new webkitSpeechRecognition();
  recognition.lang = "mr-IN";
  recognition.interimResults = false;
  recognition.start();

  recognition.onresult = function(e){
    let text = e.results[0][0].transcript;
    out.innerHTML += "<br>ЁЯЧгя╕П " + text;

    /* ===== STEP 0 ===== */
    if(step === 0){

      if(true){  // ЁЯФ┤ ADD ONLY (syntax fix)

        if(text.includes("рдбреЛрдХреЗ")){
          disease="рдбреЛрдХреЗрджреБрдЦреА"; medicine="рдкреЗрдирдХрд┐рд▓рд░";
          doseInfo="рджрд┐рд╡рд╕рд╛рддреВрди реи рд╡реЗрд│рд╛. рд╕рдХрд╛рд│реА рдЖрдгрд┐ рд╕рдВрдзреНрдпрд╛рдХрд╛рд│реА рдЬреЗрд╡рдгрд╛рдирдВрддрд░.";
        }
        else if(text.includes("рд╕рд░реНрджреА")){
          disease="рд╕рд░реНрджреА"; medicine="рдХреЛрд▓реНрдб рдЯреЕрдмреНрд▓реЗрдЯ";
          doseInfo="рджрд┐рд╡рд╕рд╛рддреВрди реи рд╡реЗрд│рд╛. рд╕рдХрд╛рд│реА рдЖрдгрд┐ рд╕рдВрдзреНрдпрд╛рдХрд╛рд│реА.";
        }
        else if(text.includes("рдЦреЛрдХрд▓рд╛")){
          disease="рдЦреЛрдХрд▓рд╛"; medicine="рдЦреЛрдХрд▓реНрдпрд╛рдЪреА рдЧреЛрд│реА";
          doseInfo="рджрд┐рд╡рд╕рд╛рддреВрди реи рддреЗ рей рд╡реЗрд│рд╛. рд╕рдХрд╛рд│реА, рджреБрдкрд╛рд░реА рдЖрдгрд┐ рд╕рдВрдзреНрдпрд╛рдХрд╛рд│реА.";
        }
        else if(text.includes("рдкреЛрдЯ")){
          disease="рдкреЛрдЯрджреБрдЦреА"; medicine="рдЕрдБрдЯреЕрд╕рд┐рдб";
          doseInfo="рдЬреЗрд╡рдгрд╛рдирдВрддрд░ рджрд┐рд╡рд╕рд╛рддреВрди реи рд╡реЗрд│рд╛. рд╕рдХрд╛рд│реА рдЖрдгрд┐ рд╕рдВрдзреНрдпрд╛рдХрд╛рд│реА.";
        }
        else if(text.includes("рдЬрдЦрдо")){
          disease="рдЬрдЦрдо"; medicine="рдХреЙрдЯрди рдЖрдгрд┐ рдЕрдБрдЯрд┐рд╕реЗрдкреНрдЯрд┐рдХ";
          doseInfo="рдЖрдзреА рдЕрдБрдЯрд┐рд╕реЗрдкреНрдЯрд┐рдХ рд▓рд╛рд╡рд╛, рдирдВрддрд░ рдХреЙрдЯрди рд╡рд╛рдкрд░рд╛.";
        }
        else if(text.includes("рдЪрдХреНрдХрд░")){
          disease="рдЪрдХреНрдХрд░"; medicine="ORS";
          doseInfo="ORS рдкрд╛рдгреНрдпрд╛рдд рдорд┐рд╕рд│реВрди рдкреНрдпрд╛.";
        }
        else{
          speak("рд╣рд╛ рдЖрдЬрд╛рд░ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА.", true);
          return;
        }
      }

      step = 1;
      speak("рддреБрд▓рд╛ " + disease + " рдЖрд╣реЗ рдХрд╛?");
      beepAndListen();
    }

    /* ===== STEP 1 ===== */
    else if(step === 1){
      if(text.includes("рд╣реЛ")){

        if(disease==="рдбреЛрдХреЗрджреБрдЦреА") sendToESP32("A");
        else if(disease==="рд╕рд░реНрджреА") sendToESP32("B");
        else if(disease==="рдЦреЛрдХрд▓рд╛") sendToESP32("C");
        else if(disease==="рдкреЛрдЯрджреБрдЦреА") sendToESP32("D");

        speak(
          "рдФрд╖рдзрд╛рдЪреЗ рдирд╛рд╡ рдЖрд╣реЗ " + medicine +
          ". рдбреЛрд╕ рдЕрд╕рд╛ рдЖрд╣реЗ. " + doseInfo +
          ". рдЬрд░ рдлрд░рдХ рдкрдбрд▓рд╛ рдирд╛рд╣реА рддрд░ рдбреЙрдХреНрдЯрд░рд╛рдВрдЪрд╛ рд╕рд▓реНрд▓рд╛ рдШреНрдпрд╛.",
          true
        );
      } else {
        speak("рдбреЙрдХреНрдЯрд░рд╛рдВрдЪрд╛ рд╕рд▓реНрд▓рд╛ рдШреНрдпрд╛.", true);
      }
      step = 0;
    }
  };

  recognition.onend = function(){
    if(!resetting){
      setTimeout(()=> recognition.start(), 800);
    }
  };
}

/* ========== CAMERA AUTO ========== */
navigator.mediaDevices.getUserMedia({video:true})
.then(s=>{
  cam.srcObject = s;
  speak("рддреБрд▓рд╛ рдХрд╛рдп рддреНрд░рд╛рд╕ рд╣реЛрддреЛрдп?");
  beepAndListen();
});

/* ========== BUTTON ========== */
function manualStart(){
  if(resetting) return;
  step = 0;
  speak("рдХреГрдкрдпрд╛ рддреБрдордЪреА рд╕рдорд╕реНрдпрд╛ рд╕рд╛рдВрдЧрд╛");
  beepAndListen();
}
</script>

</body>
</html>
